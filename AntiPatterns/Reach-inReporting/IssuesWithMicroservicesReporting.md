## マイクロサービスのレポートに関する問題

レポートの問題は2つの要素があります。タイムリーにレポートデータを取得するにはどうすればよいかと、
そうした場合でもどのようにサービスとそのデータの間の境界付けられたコンテキストを維持するのかです。
マイクロサービス内の境界付けられたコンテキストにはサービスとそれに対応するデータが含まれており、
それを維持することが非常に重要だということを覚えておいてください。

マイクロサービスアーキテクチャで通常扱われるレポート出力の手段の1つに、データベースプルモデルを使用することがあります。
このモデルでは、レポートサービス（またはレポートリクエスト）がサービスデータベースから直接データを取得します。
図4-1にこの手法について記載します。

![データベースプルレポートモデル](./img/4-1.png)  
図4-1. データベースプルレポートモデル

論理的に考えれば、タイムリーなデータを取得する最も迅速かつ簡単な方法は直接アクセスすることです。
これを聞いた時点では良いアイデアのように思えるかも知れませんが、サービスとレポートサービスとの間に大きな相互依存関係が生まれてしまいます。
これは、共有データベースを介してアプリケーションを結合する共有データベース統合形式の典型的な実装です。
この場合、サービスはもはやサービス自身に対応するデータを所有していないことを意味しています。
サービスデータベースのスキーマの変更やリファクタリングを行う際には、レポートサービスも変更しなければなりません。
その結果、サービスとデータ間の重要な境界付けられたコンテキストを破壊してしまうのです。

データ結合の問題を回避する方法は、HTTPプルモデルと呼ばれる別の手法を使うことです。
このモデルでは、レポートサービスは各サービスデータベースに直接アクセスするのではなく、各サービスに静的なHTTP呼出しを行い、データを要求します。
このモデルについて、図4-2に記載します。

![HTTPプルレポートモデル](./img/4-2.png)  
図4-2. HTTPプルレポートモデル

このモデルは各サービスの境界付けられたコンテキストを保持しますが、特に複雑なレポートリクエストの場合には残念ながら遅すぎます。
さらに、リクエストされたレポートによっては単純なHTTP呼出しのペイロードに対してデータ量が大きすぎるかも知れません。

HTTPプルモデルに関連する問題に対応する3番目の選択肢は、図4-3に示すバッチプルモデルを使用することです。
このモデルでは、集計および要約されたレポートデータを含む独立したレポートデータベースまたはデータウェアハウスが使用されていることに注目してください。
レポートデータベースは通常、夜間に実行されるバッチジョブによって生成されます。
変更されたすべてのレポートデータを抽出した後に集計・要約し、レポートデータベースまたはデータウェアハウスに挿入します。

![バッチプルレポートモデル](./img/4-3.png)  
図4-3. バッチプルレポートモデル

バッチプルモデルは、HTTPプルモデルと同じ問題を共有しています。つまり、どちらも共有データベース統合形式を実装しています。その結果、各サービスの境界付けられたコンテキストを破壊します。
サービスデータベースのスキーマが変更された場合は、バッチデータのアップロード処理も変更する必要があります。