### CHAPTER 7

# ”変わらない契約”の落とし穴

すべてのマイクロサービスは、サービス利用者とマイクロサービスとの間で契約を結んでいます。
契約には通常、予想される入出力データを指定するスキーマや時には操作名称（サービスの実装方法に依存）が含まれています。
契約は通常サービスによって所有され、XML、JSON、JavaまたはC#オブジェクトなどの形式で表現できます。
もちろん、それらの契約は決して変わることはありません。そうでしょうか？いいえ、それは間違いです。

”変わらない契約”の落とし穴は、サービス契約を最初から、あるいはまったくバージョン管理しなかった場合に発生します。
契約のバージョン管理は、破壊的変更（契約を変更することで、その契約を使用しているすべてのサービス利用者を破壊すること）
を回避するだけでなく、下位互換性をサポートすることによって機敏性を維持するためにも絶対に重要です。

ここでは、契約をバージョン管理しないことでトラブルに陥る例を紹介します。
３つの異なるクライアント（クライアント1、クライアント2、およびクライアント3）がアクセスするマイクロサービスがあるとします。
クライアント1はすぐにサービス契約を変更したいと考えています。
クライアント2とクライアント3を確認して、変更に対応できるかどうかを確認すると、
両クライアントが、進行中の他の事柄によりその変更を実装するのに数週間かかることを知らされます。
クライアント2と3との調整をする必要があるため、変更を行うには数週間かかることをクライアント1に通知する必要があります。
しかしながら、クライアント1は数週間も待つことはできません。

契約をバージョン管理し、それによって下位互換性を提供することで、クライアント1の要求に関してより迅速に対応することができます。
敏捷性とは、変化にどれだけ早く対応できるかということです。
最初から契約を適切にバージョン管理していたならば、新しいバージョンの契約、たとえばバージョン1.1を作成するだけで、
クライアント1の契約変更要求に即座に対応することができたでしょう。
クライアント2と3はどちらもバージョン1.0の契約を使用しているので、両クライアントの対応を待つことなくすぐに変更を実装できます。
さらに、あなたは”破壊的変更”を起こすことなく、変更を加えることができるのです。

契約のバージョン管理には２つの基本的な手法があります。
ヘッダーレベルのバージョン管理と契約スキーマ自体のバージョン管理です。
この章では、これらの手法のそれぞれについて詳細に説明しますが、まず例を見てみましょう。
